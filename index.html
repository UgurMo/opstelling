<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teamopstelling 3-3-1 – 4 kwarten</title>
  <style>
*{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:#111}
header{padding:16px 20px;border-bottom:1px solid #eee}
h1{margin:0 0 4px 0;font-size:22px}
.sub{margin:0;color:#555}
.controls{display:flex;justify-content:space-between;gap:16px;padding:10px 20px;align-items:center;border-bottom:1px solid #eee;flex-wrap:wrap}
.controls .left button{margin-right:8px}
button{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
button:hover{border-color:#bbb}
button.ghost{background:#f8f8f8}
.players{padding:16px 20px}
.players .scroll{overflow:auto;border:1px solid #eee;border-radius:8px}
table{border-collapse:collapse;width:100%;min-width:560px}
th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left}
th{background:#f5f7fb;position:sticky;top:0}
input[type="number"]{width:5rem}
select, input[type="text"], input[type="number"]{padding:6px;border:1px solid #ddd;border-radius:6px}
.hint{color:#666;margin-top:8px}
.quarters{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;padding:0 20px 20px}
.quarter{border:1px solid #eee;border-radius:12px;padding:12px}
.quarter h3{margin:6px 6px 12px 6px;display:flex;justify-content:space-between;align-items:center}
.badge{font-size:12px;background:#fff3cd;border:1px solid #ffe08a;color:#664d03;padding:2px 6px;border-radius:6px}
.pitch{background:#e9f7e9;border:1px solid #cfe8cf;border-radius:12px;padding:12px;margin:8px}
.row{display:flex;gap:8px;justify-content:space-between;margin:8px 0}
.slot,.staging-slot{flex:1;min-height:44px;background:#fff;border:1px solid #c4dec4;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:6px;text-align:center;cursor:grab;user-select:none}
.slot.wide,.staging-slot.wide{flex:2}
.row.staging .staging-slot{background:#f8fff8;border-style:dashed}
.reserves{padding:8px;background:#e7f3ff;border:1px solid #bcd6f8;border-radius:10px}
.reserves ol{margin:6px 0 0 16px;min-height:44px;border:1px dashed #bcd6f8;border-radius:8px;padding:8px;background:#e7f3ff;list-style:decimal}
.reserves li{padding:6px 8px;border:1px solid #bcd6f8;border-radius:6px;margin:6px 0;background:#e7f3ff;cursor:grab;user-select:none}
.droppable{box-shadow:0 0 0 2px #a3d2a3 inset}
.placeholder{border:2px dashed #6aa4ff;background:#eaf1ff;height:36px;border-radius:6px;margin:6px 0}
footer{border-top:1px solid #eee;padding:12px 20px;color:#666}
.picker{position:fixed;inset:0;background:rgba(0,0,0,.32);display:flex;align-items:center;justify-content:center}
.picker.hidden{display:none}
.picker-inner{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:520px;max-width:calc(100% - 32px)}
.picker-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
.picker-head button{border:none;background:#f4f4f4;border-radius:8px;padding:4px 10px;cursor:pointer}
.picker-body{padding:12px}
#pickerFilter{width:100%;margin:8px 0}
#pickerList{list-style:none;margin:0;padding:0;max-height:300px;overflow:auto;border:1px solid #eee;border-radius:8px}
#pickerList li{padding:8px 10px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center}
#pickerList li:last-child{border-bottom:none}
#pickerList li button{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer}
@media print{
  header,.controls,.players,footer,.picker{display:none}
  .quarters{grid-template-columns:1fr 1fr}
  body{background:#fff}
}
  </style>
</head>
<body>
  <header>
    <h1>Teamopstelling 3-3-1 – 4 kwarten</h1>
    <p class="sub">8 spelers (incl. keeper) · 11 totaal · Q1: "Te laat" is reserve · Q2–Q4: "Te laat" mag meedoen</p>
  </header>

  <section class="controls">
    <div class="left">
      <button id="generateBtn">Opstellingen genereren</button>
      <button id="saveBtn">Opslaan</button>
      <button id="loadDefaultsBtn" class="ghost">Laad standaardteam</button>
      <button id="resetBtn" class="ghost">Reset naar lege standaard</button>
      <button id="printBtn" class="ghost">Print / PDF</button>
    </div>
    <div class="right">
      <label><input type="checkbox" id="lockDrag"> Drag & drop vergrendelen</label>
      <label style="margin-left:12px"><input type="checkbox" id="editMode"> Bewerkmodus (klik om speler te kiezen)</label>
    </div>
  </section>

  <section class="players">
    <h2>Spelers</h2>
    <div class="scroll">
    <table>
      <thead>
        <tr>
          <th style="width:6rem">Volgorde</th>
          <th>Naam</th>
          <th>Rol</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="playersBody"></tbody>
    </table>
    </div>
    <p class="hint">Volgorde bepaalt selectieprioriteit (1 = eerste). Status: <b>Aanwezig</b>, <b>Te laat</b>, <b>Afwezig</b>.</p>
  </section>

  <section class="quarters">
    <!-- KWART 1 -->
    <div class="quarter" id="q1">
      <h3>Kwart 1 <span class="badge">Te laat → reserve</span></h3>
      <div class="pitch">
        <div class="row"><div class="slot wide" data-slot="q1-gk">Keeper</div></div>
        <div class="row">
          <div class="slot" data-slot="q1-d1">D1</div>
          <div class="slot" data-slot="q1-d2">D2</div>
          <div class="slot" data-slot="q1-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q1-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q1-sd2" title="Reserve onder D2">—</div>
          <div class="staging-slot" data-slot="q1-sd3" title="Reserve onder D3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q1-m1">M1</div>
          <div class="slot" data-slot="q1-m2">M2</div>
          <div class="slot" data-slot="q1-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q1-sm1" title="Reserve onder M1">—</div>
          <div class="staging-slot" data-slot="q1-sm2" title="Reserve onder M2">—</div>
          <div class="staging-slot" data-slot="q1-sm3" title="Reserve onder M3">—</div>
        </div>
        <div class="row"><div class="slot wide" data-slot="q1-f1">F1</div></div>
        <div class="row staging"><div class="staging-slot wide" data-slot="q1-sf1" title="Reserve onder F1">—</div></div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q1-res" class="reserve-list" data-quarter="q1"></ol>
      </div>
    </div>

    <!-- KWART 2 -->
    <div class="quarter" id="q2">
      <h3>Kwart 2</h3>
      <div class="pitch">
        <div class="row"><div class="slot wide" data-slot="q2-gk">Keeper</div></div>
        <div class="row">
          <div class="slot" data-slot="q2-d1">D1</div>
          <div class="slot" data-slot="q2-d2">D2</div>
          <div class="slot" data-slot="q2-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q2-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q2-sd2">—</div>
          <div class="staging-slot" data-slot="q2-sd3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q2-m1">M1</div>
          <div class="slot" data-slot="q2-m2">M2</div>
          <div class="slot" data-slot="q2-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q2-sm1">—</div>
          <div class="staging-slot" data-slot="q2-sm2">—</div>
          <div class="staging-slot" data-slot="q2-sm3">—</div>
        </div>
        <div class="row"><div class="slot wide" data-slot="q2-f1">F1</div></div>
        <div class="row staging"><div class="staging-slot wide" data-slot="q2-sf1">—</div></div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q2-res" class="reserve-list" data-quarter="q2"></ol>
      </div>
    </div>

    <!-- KWART 3 -->
    <div class="quarter" id="q3">
      <h3>Kwart 3</h3>
      <div class="pitch">
        <div class="row"><div class="slot wide" data-slot="q3-gk">Keeper</div></div>
        <div class="row">
          <div class="slot" data-slot="q3-d1">D1</div>
          <div class="slot" data-slot="q3-d2">D2</div>
          <div class="slot" data-slot="q3-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q3-sd1">—</div>
          <div class="staging-slot" data-slot="q3-sd2">—</div>
          <div class="staging-slot" data-slot="q3-sd3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q3-m1">M1</div>
          <div class="slot" data-slot="q3-m2">M2</div>
          <div class="slot" data-slot="q3-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q3-sm1">—</div>
          <div class="staging-slot" data-slot="q3-sm2">—</div>
          <div class="staging-slot" data-slot="q3-sm3">—</div>
        </div>
        <div class="row"><div class="slot wide" data-slot="q3-f1">F1</div></div>
        <div class="row staging"><div class="staging-slot wide" data-slot="q3-sf1">—</div></div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q3-res" class="reserve-list" data-quarter="q3"></ol>
      </div>
    </div>

    <!-- KWART 4 -->
    <div class="quarter" id="q4">
      <h3>Kwart 4</h3>
      <div class="pitch">
        <div class="row"><div class="slot wide" data-slot="q4-gk">Keeper</div></div>
        <div class="row">
          <div class="slot" data-slot="q4-d1">D1</div>
          <div class="slot" data-slot="q4-d2">D2</div>
          <div class="slot" data-slot="q4-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q4-sd1">—</div>
          <div class="staging-slot" data-slot="q4-sd2">—</div>
          <div class="staging-slot" data-slot="q4-sd3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q4-m1">M1</div>
          <div class="slot" data-slot="q4-m2">M2</div>
          <div class="slot" data-slot="q4-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q4-sm1">—</div>
          <div class="staging-slot" data-slot="q4-sm2">—</div>
          <div class="staging-slot" data-slot="q4-sm3">—</div>
        </div>
        <div class="row"><div class="slot wide" data-slot="q4-f1">F1</div></div>
        <div class="row staging"><div class="staging-slot wide" data-slot="q4-sf1">—</div></div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q4-res" class="reserve-list" data-quarter="q4"></ol>
      </div>
    </div>
  </section>

  <!-- Speeltijdteller -->
  <section class="totals" style="padding:0 20px 20px">
    <h2>Speeltijd per speler</h2>
    <ul id="totalsList" style="margin:8px 0 0 0; padding-left:18px"></ul>
    <p class="hint">Telling: veldpositie = 1 kwart · staging (onder positie) = 0,5 kwart · reserve = 0.</p>
  </section>

  <!-- Picker -->
  <div id="picker" class="picker hidden">
    <div class="picker-inner">
      <div class="picker-head">
        <strong>Speler kiezen</strong>
        <button id="pickerClose" title="Sluiten">×</button>
      </div>
      <div class="picker-body">
        <label>Filter: <input id="pickerFilter" type="text" placeholder="Zoek naam..."></label>
        <ul id="pickerList"></ul>
      </div>
    </div>
  </div>

  <footer>
    <p>Gemaakt voor Uğur · Werkt volledig offline · Slaat alles lokaal op.</p>
  </footer>

<script>
/* ====== DATA & STATE ====== */
const DEFAULT_PLAYERS = [
  {order:1, name:'Jim', role:'Keeper', status:'Aanwezig'},
  {order:2, name:'Levi', role:'Veldspeler', status:'Aanwezig'},
  {order:3, name:'Lou', role:'Veldspeler', status:'Aanwezig'},
  {order:4, name:'Kanis', role:'Veldspeler', status:'Aanwezig'},
  {order:5, name:'Zeid', role:'Veldspeler', status:'Aanwezig'},
  {order:6, name:'Remy', role:'Veldspeler', status:'Aanwezig'},
  {order:7, name:'Ali', role:'Veldspeler', status:'Aanwezig'},
  {order:8, name:'Devaino', role:'Veldspeler', status:'Aanwezig'},
  {order:9, name:'Nova', role:'Veldspeler', status:'Aanwezig'},
  {order:10, name:'Sam', role:'Veldspeler', status:'Aanwezig'},
  {order:11, name:'Aiden', role:'Veldspeler', status:'Aanwezig'}
];
const STORAGE_KEY='teamopstelling331';

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return {players:DEFAULT_PLAYERS, layout:null};
    const obj=JSON.parse(raw);
    if(!obj.players||!Array.isArray(obj.players)) obj.players=DEFAULT_PLAYERS;
    if(!('layout' in obj)) obj.layout=null;
    return obj;
  }catch(e){ return {players:DEFAULT_PLAYERS, layout:null}; }
}
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

let state=loadState();

/* ====== UI: SPELERS TABEL ====== */
const playersBody=document.getElementById('playersBody');
function renderPlayers(){
  playersBody.innerHTML='';
  const players=[...state.players].sort((a,b)=>a.order-b.order);
  players.forEach(p=>{
    const tr=document.createElement('tr');

    const tdOrder=document.createElement('td');
    const inpOrder=document.createElement('input');
    inpOrder.type='number';inpOrder.min='1';inpOrder.max='99';inpOrder.value=p.order;
    inpOrder.addEventListener('change',()=>{p.order=Number(inpOrder.value)||p.order;saveAll();});
    tdOrder.appendChild(inpOrder);tr.appendChild(tdOrder);

    const tdName=document.createElement('td');
    const inpName=document.createElement('input');
    inpName.type='text';inpName.value=p.name;
    inpName.addEventListener('input',()=>{p.name=inpName.value;saveAll();});
    tdName.appendChild(inpName);tr.appendChild(tdName);

    const tdRole=document.createElement('td');
    const selRole=document.createElement('select');
    ['Keeper','Veldspeler'].forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;if(p.role===opt)o.selected=true;selRole.appendChild(o)});
    selRole.addEventListener('change',()=>{p.role=selRole.value;saveAll();});
    tdRole.appendChild(selRole);tr.appendChild(tdRole);

    const tdStatus=document.createElement('td');
    const selStatus=document.createElement('select');
    ['Aanwezig','Te laat','Afwezig'].forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;if(p.status===opt)o.selected=true;selStatus.appendChild(o)});
    selStatus.addEventListener('change',()=>{p.status=selStatus.value;saveAll();});
    tdStatus.appendChild(selStatus);tr.appendChild(tdStatus);

    playersBody.appendChild(tr);
  });
}

/* ====== SELECTIELOGICA ====== */
function pickGK(players, allowLate){
  const eligible=players.filter(p=>p.status!=='Afwezig'&&(allowLate||p.status==='Aanwezig')).sort((a,b)=>a.order-b.order);
  const keepers=eligible.filter(p=>p.role==='Keeper');
  return keepers[0]||eligible[0]||null;
}
function pickField(players,gk,allowLate){
  const eligible=players.filter(p=>p.name!==gk?.name&&p.status!=='Afwezig'&&(allowLate||p.status==='Aanwezig')).sort((a,b)=>a.order-b.order);
  return {field:eligible.slice(0,7),extras:eligible.slice(7)};
}
function pickReservesQ1(players,gk){
  const late=players.filter(p=>p.status==='Te laat').sort((a,b)=>a.order-b.order);
  const presentElig=players.filter(p=>p.status==='Aanwezig'&&p.name!==gk?.name).sort((a,b)=>a.order-b.order);
  const presentAfter7=presentElig.slice(7);
  return [...late,...presentAfter7].slice(0,3);
}

/* ====== RENDER KWARTEN ====== */
function fillQuarter(prefix,gk,field,reserves){
  const slots=['d1','d2','d3','m1','m2','m3','f1'];
  const gkEl=document.querySelector(`[data-slot="${prefix}-gk"]`);
  gkEl.textContent=gk?gk.name:'—';gkEl.dataset.assigned=gk?gk.name:'';

  slots.forEach((s,i)=>{
    const el=document.querySelector(`[data-slot="${prefix}-${s}"]`);
    const name=field[i]?.name||'—';
    el.textContent=name; el.dataset.assigned=name==='—'?'':name;
  });

  document.querySelectorAll(`[data-slot^="${prefix}-s"]`).forEach(st=>{st.textContent='—';st.dataset.assigned='';});

  const resOl=document.getElementById(`${prefix}-res`);
  resOl.innerHTML='';
  (reserves||[]).forEach(r=> resOl.appendChild(makeReserveItem(r.name)));
}

/* ====== LAYOUT OPSLAAN/HERSTELLEN ====== */
const SLOT_KEYS = ['gk','d1','d2','d3','m1','m2','m3','f1'];
const STAGING_KEYS = ['sd1','sd2','sd3','sm1','sm2','sm3','sf1'];

function readQuarter(prefix){
  const slots={}; SLOT_KEYS.forEach(k=>{
    const el=document.querySelector(`[data-slot="${prefix}-${k}"]`);
    slots[k]=normalizeName(el?.textContent);
  });
  const staging={}; STAGING_KEYS.forEach(k=>{
    const el=document.querySelector(`[data-slot="${prefix}-${k}"]`);
    staging[k]=normalizeName(el?.textContent);
  });
  const reserves=[...document.querySelectorAll(`#${prefix}-res .reserve-item`)].map(li=>normalizeName(li.textContent)).filter(Boolean);
  return {slots, staging, reserves};
}
function writeQuarter(prefix, qdata){
  const {slots={}, staging={}, reserves=[]}=qdata||{};
  SLOT_KEYS.forEach(k=>{
    const el=document.querySelector(`[data-slot="${prefix}-${k}"]`);
    const name=slots[k]||'';
    el.textContent=name||'—'; el.dataset.assigned=name||'';
  });
  STAGING_KEYS.forEach(k=>{
    const el=document.querySelector(`[data-slot="${prefix}-${k}"]`);
    const name=staging[k]||'';
    el.textContent=name||'—'; el.dataset.assigned=name||'';
  });
  const resOl=document.getElementById(`${prefix}-res`);
  resOl.innerHTML='';
  reserves.forEach(n=>{ if(n) resOl.appendChild(makeReserveItem(n)); });
}
function normalizeName(t){ t=(t||'').trim(); return (t==='—' || t==='Keeper' || t==='D1'||t==='D2'||t==='D3'||t==='M1'||t==='M2'||t==='M3'||t==='F1') ? '' : t; }

function saveAll(){
  saveState({
    players: state.players,
    layout: {
      q1: readQuarter('q1'),
      q2: readQuarter('q2'),
      q3: readQuarter('q3'),
      q4: readQuarter('q4')
    }
  });
  updateTotalsUI(); // update speeltijd na elke wijziging of save
}

function restoreLayoutIfAvailable(){
  if(!state.layout) return false;
  ['q1','q2','q3','q4'].forEach(q=> writeQuarter(q, state.layout[q]));
  enableDnD();
  hookSlotClicks();
  return true;
}

/* ====== GENERATE ALL ====== */
function generateAll(){
  const roster=[...state.players];

  const gk1=pickGK(roster,false);const {field:f1}=pickField(roster,gk1,false);const r1=pickReservesQ1(roster,gk1);fillQuarter('q1',gk1,f1,r1);

  const gk2=pickGK(roster,true);const {field:f2,extras:ex2}=pickField(roster,gk2,true);fillQuarter('q2',gk2,f2,ex2.slice(0,3));
  const gk3=pickGK(roster,true);const {field:f3,extras:ex3}=pickField(roster,gk3,true);fillQuarter('q3',gk3,f3,ex3.slice(0,3));
  const gk4=pickGK(roster,true);const {field:f4,extras:ex4}=pickField(roster,gk4,true);fillQuarter('q4',gk4,f4,ex4.slice(0,3));

  enableDnD();
  hookSlotClicks();
  saveAll(); // direct opslaan en totals bijwerken
}

/* ====== DnD HELPERS (slots & staging) ====== */
let dragName=null, dragSource=null, dragQuarter=null, originEl=null;

function markDroppables(on,q){
  document.querySelectorAll(`[data-slot^="${q}-"]`).forEach(el=>{el.classList.toggle('droppable',on);});
  document.getElementById(`${q}-res`)?.classList.toggle('droppable',on);
}
function sameQuarter(targetEl){
  const ds=targetEl.dataset.slot;
  if(ds) return ds.split('-')[0]===dragQuarter;
  const dq=targetEl.closest('.reserve-list')?.dataset.quarter;
  return dq===dragQuarter;
}
function removeNameFromQuarter(q,name){
  if(!name) return;
  document.querySelectorAll(`[data-slot^="${q}-"]`).forEach(el=>{
    if(el.dataset.assigned===name||el.textContent===name){ el.textContent='—'; el.dataset.assigned=''; }
  });
  const li=[...document.querySelectorAll(`#${q}-res .reserve-item`)].find(x=>x.dataset.name===name);
  if(li) li.remove();
}

/* ====== RESERVES: losse draggable items + reordering ====== */
function makeReserveItem(name){
  const li=document.createElement('li');
  li.textContent=name;
  li.className='reserve-item';
  li.draggable=true;
  li.dataset.name=name;
  return li;
}
function getReserveInsertion(list, y){
  const items=[...list.querySelectorAll('.reserve-item:not(.dragging)')];
  let closest={offset:Number.NEGATIVE_INFINITY, element:null};
  items.forEach(it=>{
    const rect=it.getBoundingClientRect();
    const offset=y - (rect.top + rect.height/2);
    if(offset<0 && offset>closest.offset){ closest={offset, element:it}; }
  });
  return closest.element;
}

/* Activeer DnD op slots/staging + reserve-lijsten */
function enableDnD(){
  // slots
  document.querySelectorAll('.slot').forEach(slot=>{
    slot.draggable=true;
    slot.addEventListener('dragstart',e=>{
      if(document.getElementById('lockDrag').checked||slot.textContent==='—'){e.preventDefault();return;}
      dragName=slot.textContent; dragSource='slot'; dragQuarter=slot.dataset.slot.split('-')[0]; originEl=slot;
      e.dataTransfer.setData('text/plain', dragName); markDroppables(true, dragQuarter);
    });
    slot.addEventListener('dragover',e=>{ if(document.getElementById('lockDrag').checked||!sameQuarter(slot)) return; e.preventDefault(); slot.classList.add('droppable'); });
    slot.addEventListener('dragleave',()=>slot.classList.remove('droppable'));
    slot.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked||!sameQuarter(slot)) return;
      e.preventDefault(); slot.classList.remove('droppable');
      const toName=slot.textContent;

      if(dragSource==='slot' && originEl!==slot){
        originEl.textContent=toName; originEl.dataset.assigned=toName==='—'?'':toName;
        slot.textContent=dragName; slot.dataset.assigned=dragName;
      } else if(dragSource==='staging'){
        const occupy=toName&&toName!=='—'?toName:null;
        originEl.textContent='—'; originEl.dataset.assigned='';
        if(occupy) appendToReserve(dragQuarter, occupy);
        slot.textContent=dragName; slot.dataset.assigned=dragName;
      } else if(dragSource==='reserve'){
        if(toName && toName!=='—') appendToReserve(dragQuarter, toName);
        slot.textContent=dragName; slot.dataset.assigned=dragName;
        if(currentDraggedReserveItem) currentDraggedReserveItem.remove();
      }
      saveAll();
      resetDragState(); markDroppables(false, dragQuarter);
    });
    slot.addEventListener('dragend',()=>{markDroppables(false, dragQuarter); resetDragState();});
  });

  // staging-slots
  document.querySelectorAll('.staging-slot').forEach(st=>{
    st.draggable=true;
    st.addEventListener('dragstart',e=>{
      if(document.getElementById('lockDrag').checked||st.textContent==='—'){e.preventDefault();return;}
      dragName=st.textContent; dragSource='staging'; dragQuarter=st.dataset.slot.split('-')[0]; originEl=st;
      e.dataTransfer.setData('text/plain', dragName); markDroppables(true, dragQuarter);
    });
    st.addEventListener('dragover',e=>{ if(document.getElementById('lockDrag').checked||!sameQuarter(st)) return; e.preventDefault(); st.classList.add('droppable'); });
    st.addEventListener('dragleave',()=>st.classList.remove('droppable'));
    st.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked||!sameQuarter(st)) return;
      e.preventDefault(); st.classList.remove('droppable');
      const current=st.textContent;

      if(dragSource==='slot'){
        originEl.textContent='—'; originEl.dataset.assigned='';
        if(current && current!=='—') appendToReserve(dragQuarter, current);
        st.textContent=dragName; st.dataset.assigned=dragName;
      } else if(dragSource==='reserve'){
        if(current && current!=='—') appendToReserve(dragQuarter, current);
        st.textContent=dragName; st.dataset.assigned=dragName;
        if(currentDraggedReserveItem) currentDraggedReserveItem.remove();
      } else if(dragSource==='staging' && originEl!==st){
        originEl.textContent=current; originEl.dataset.assigned=current==='—'?'':current;
        st.textContent=dragName; st.dataset.assigned=dragName;
      }
      saveAll();
      resetDragState(); markDroppables(false, dragQuarter);
    });
    st.addEventListener('dragend',()=>{markDroppables(false, dragQuarter); resetDragState();});
  });

  // reserve-lijsten: reordering + drops uit slots/staging
  document.querySelectorAll('.reserve-list').forEach(list=>{
    let placeholder=null;
    list.addEventListener('dragover',e=>{
      if(document.getElementById('lockDrag').checked || list.dataset.quarter!==dragQuarter) return;
      e.preventDefault(); list.classList.add('droppable');

      if(!placeholder){ placeholder=document.createElement('div'); placeholder.className='placeholder'; }
      const beforeEl=getReserveInsertion(list, e.clientY);
      if(beforeEl) list.insertBefore(placeholder, beforeEl); else list.appendChild(placeholder);
    });
    list.addEventListener('dragleave',()=>{ list.classList.remove('droppable'); if(placeholder) placeholder.remove(); });
    list.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked || list.dataset.quarter!==dragQuarter) return;
      e.preventDefault(); list.classList.remove('droppable');

      if(dragSource==='reserve'){
        if(placeholder){
          if(currentDraggedReserveItem && currentDraggedReserveItem!==placeholder){
            currentDraggedReserveItem.remove();
            const li=makeReserveItem(dragName);
            list.insertBefore(li, placeholder);
            activateReserveItem(li);
          }
        }
      } else {
        if(originEl){
          const name=originEl.textContent;
          originEl.textContent='—'; originEl.dataset.assigned='';
          const li=makeReserveItem(name);
          if(placeholder) list.insertBefore(li, placeholder); else list.appendChild(li);
          activateReserveItem(li);
        }
      }
      if(currentDraggedReserveItem) currentDraggedReserveItem.classList.remove('dragging');
      if(placeholder) placeholder.remove();
      saveAll();
      resetDragState(); markDroppables(false, dragQuarter);
    });
  });

  // bestaande reserve-items actief maken
  document.querySelectorAll('.reserve-item').forEach(activateReserveItem);
}

let currentDraggedReserveItem=null;
function activateReserveItem(li){
  li.addEventListener('dragstart',e=>{
    if(document.getElementById('lockDrag').checked){e.preventDefault();return;}
    dragName=li.dataset.name||li.textContent; dragSource='reserve';
    dragQuarter=li.closest('.reserve-list')?.dataset.quarter; currentDraggedReserveItem=li; li.classList.add('dragging');
    e.dataTransfer.setData('text/plain', dragName); markDroppables(true, dragQuarter);
  });
  li.addEventListener('dragend',()=>{
    li.classList.remove('dragging'); markDroppables(false, dragQuarter); resetDragState();
  });
}

function appendToReserve(qPrefix,name){
  const ol=document.getElementById(`${qPrefix}-res`);
  const li=makeReserveItem(name);
  ol.appendChild(li);
  activateReserveItem(li);
}

function resetDragState(){ dragName=null; dragSource=null; dragQuarter=null; originEl=null; currentDraggedReserveItem=null; }

/* ====== PICKER (klikmodus) ====== */
const editMode=document.getElementById('editMode');
const picker=document.getElementById('picker');
const pickerList=document.getElementById('pickerList');
const pickerFilter=document.getElementById('pickerFilter');
const pickerClose=document.getElementById('pickerClose');
let activeSlot=null;

function hookSlotClicks(){
  document.querySelectorAll('.slot, .staging-slot').forEach(el=>{
    el.addEventListener('click',()=>{
      if(!editMode.checked) return;
      activeSlot=el; buildPickerList(''); picker.classList.remove('hidden'); pickerFilter.value=''; pickerFilter.focus();
    });
  });
}
function closePicker(){ picker.classList.add('hidden'); activeSlot=null; }
pickerClose.addEventListener('click',closePicker);
picker.addEventListener('click',e=>{ if(e.target===picker) closePicker(); });
pickerFilter.addEventListener('input',()=>buildPickerList(pickerFilter.value||''));
function buildPickerList(filter){
  const roster=[...state.players];
  const qPrefix=activeSlot.dataset.slot.split('-')[0];
  const usedNames=[...document.querySelectorAll(`[data-slot^="${qPrefix}-"]`)].map(el=>el.dataset.assigned).filter(Boolean);
  pickerList.innerHTML='';
  roster
    .filter(p=>p.name.toLowerCase().includes(filter.toLowerCase()))
    .sort((a,b)=>a.order-b.order)
    .forEach(p=>{
      const li=document.createElement('li');
      const span=document.createElement('span'); span.textContent=`${p.name} · ${p.role} · ${p.status}`;
      const btn=document.createElement('button'); btn.textContent=usedNames.includes(p.name)?'Verplaatsen':'Kies';
      btn.addEventListener('click',()=>assignPlayerToSlot(p.name, activeSlot));
      li.appendChild(span); li.appendChild(btn); pickerList.appendChild(li);
    });
  const liEmpty=document.createElement('li'); const spanEmpty=document.createElement('span'); spanEmpty.textContent='— (leegmaken)';
  const btnEmpty=document.createElement('button'); btnEmpty.textContent='Leeg';
  btnEmpty.addEventListener('click',()=>assignPlayerToSlot('', activeSlot));
  liEmpty.appendChild(spanEmpty); liEmpty.appendChild(btnEmpty); pickerList.appendChild(liEmpty);
}
function assignPlayerToSlot(name,slotEl){
  const qPrefix=slotEl.dataset.slot.split('-')[0];
  if(name){ removeNameFromQuarter(qPrefix, name); }
  const prev=slotEl.textContent;
  slotEl.textContent=name||'—'; slotEl.dataset.assigned=name||'';
  if(prev && prev!=='—' && slotEl.classList.contains('slot') && name){
    appendToReserve(qPrefix, prev);
  }
  saveAll(); // direct opslaan na keuze
  closePicker();
}

/* ====== SPEELTIJD TELLEN ====== */
function computeQuarterTotals(prefix){
  const totals = new Map(); // name -> aantal kwartdelen
  // hoofdslots = 1.0
  SLOT_KEYS.forEach(k=>{
    const el = document.querySelector(`[data-slot="${prefix}-${k}"]`);
    const name = normalizeName(el?.textContent);
    if(name){ totals.set(name, (totals.get(name)||0) + 1.0); }
  });
  // staging = 0.5
  STAGING_KEYS.forEach(k=>{
    const el = document.querySelector(`[data-slot="${prefix}-${k}"]`);
    const name = normalizeName(el?.textContent);
    if(name){ totals.set(name, (totals.get(name)||0) + 0.5); }
  });
  return totals;
}
function computeAllTotals(){
  const sum = new Map();
  ['q1','q2','q3','q4'].forEach(q=>{
    const t = computeQuarterTotals(q);
    t.forEach((v,name)=> sum.set(name, (sum.get(name)||0)+v));
  });
  // zorg dat alle spelers erin staan
  state.players.forEach(p=>{ if(!sum.has(p.name)) sum.set(p.name, 0); });
  return sum;
}
function updateTotalsUI(){
  const list = document.getElementById('totalsList');
  if(!list) return;
  const nf = new Intl.NumberFormat('nl-NL', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
  const sum = computeAllTotals();

  const playersByOrder = [...state.players].sort((a,b)=> a.order - b.order)
    .map(p => ({ name:p.name, val: sum.get(p.name) ?? 0 }));

  list.innerHTML = '';
  playersByOrder.forEach(({name,val})=>{
    const li = document.createElement('li');
    const formatted = nf.format(val).replace('.', ','); // 3.5 -> 3,5
    li.textContent = `${name}: ${formatted} kwart`;
    list.appendChild(li);
  });
}

/* ====== BUTTONS ====== */
document.getElementById('generateBtn').addEventListener('click',()=>{renderPlayers();generateAll();});
document.getElementById('saveBtn').addEventListener('click',()=>{saveAll();alert('Opgeslagen! Spelers + huidige opstellingen staan lokaal opgeslagen.');});
document.getElementById('loadDefaultsBtn').addEventListener('click',()=>{
  if(!confirm('Standaardteam laden (Jim, Levi, Lou, ...)? Dit vervangt alleen de spelerslijst. Bestaande opstellingen blijven staan tenzij je opnieuw genereert.')) return;
  state.players=JSON.parse(JSON.stringify(DEFAULT_PLAYERS)); saveAll(); renderPlayers();
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm('Reset naar lege standaard (Speler 1..11) en wis opstellingen?')){
    state={players:Array.from({length:11},(_,i)=>({order:i+1,name:`Speler ${i+1}`,role:i===0?'Keeper':'Veldspeler',status:'Aanwezig'})), layout:null};
    saveState(state);
    renderPlayers();
    ['q1','q2','q3','q4'].forEach(q=>{
      SLOT_KEYS.forEach(k=>{ const el=document.querySelector(`[data-slot="${q}-${k}"]`); el.textContent = (k==='gk'?'Keeper':k.toUpperCase()); el.dataset.assigned=''; });
      STAGING_KEYS.forEach(k=>{ const el=document.querySelector(`[data-slot="${q}-${k}"]`); el.textContent='—'; el.dataset.assigned=''; });
      const ol=document.getElementById(`${q}-res`); ol.innerHTML='';
    });
    updateTotalsUI();
  }
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());

/* ====== INIT ====== */
renderPlayers();
if(!restoreLayoutIfAvailable()){ generateAll(); }
updateTotalsUI(); // initiele rendering van de speeltijdteller
</script>
</body>
</html>

<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teamopstelling 3-3-1 – 4 kwarten (v3.4.1-touch)</title>
  <style>
*{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:#111}
header{padding:16px 20px;border-bottom:1px solid #eee}
h1{margin:0 0 4px 0;font-size:22px}
.sub{margin:0;color:#555}
.controls{display:flex;justify-content:space-between;gap:16px;padding:10px 20px;align-items:center;border-bottom:1px solid #eee;flex-wrap:wrap}
.controls .left button{margin-right:8px}
button{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
button:hover{border-color:#bbb}
button.ghost{background:#f8f8f8}
.players{padding:16px 20px}
.players .scroll{overflow:auto;border:1px solid #eee;border-radius:8px}
table{border-collapse:collapse;width:100%;min-width:560px}
th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left}
th{background:#f5f7fb;position:sticky;top:0}
input[type="number"]{width:5rem}
select, input[type="text"], input[type="number"]{padding:6px;border:1px solid #ddd;border-radius:6px}
.hint{color:#666;margin-top:8px}
.quarters{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;padding:0 20px 20px}
.quarter{border:1px solid #eee;border-radius:12px;padding:12px}
.quarter h3{margin:6px 6px 12px 6px;display:flex;justify-content:space-between;align-items:center}
.badge{font-size:12px;background:#fff3cd;border:1px solid #ffe08a;color:#664d03;padding:2px 6px;border-radius:6px}
.pitch{background:#e9f7e9;border:1px solid #cfe8cf;border-radius:12px;padding:12px;margin:8px}
.row{display:flex;gap:8px;justify-content:space-between;margin:8px 0}
.slot,.staging-slot{flex:1;min-height:44px;background:#fff;border:1px solid #c4dec4;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:6px;text-align:center;cursor:grab}
.slot.wide,.staging-slot.wide{flex:2}
.row.staging .staging-slot{background:#f8fff8;border-style:dashed}
.reserves{padding:8px;background:#e7f3ff;border:1px solid #bcd6f8;border-radius:10px}
.reserves ol{margin:6px 0 0 16px;min-height:44px;border:1px dashed #bcd6f8;border-radius:8px;padding:8px;background:#e7f3ff}
.reserves li{padding:6px 8px;border:1px solid #bcd6f8;border-radius:6px;margin:6px 0;background:#e7f3ff;cursor:grab;}

/* DnD visual cues */
.droppable{box-shadow:0 0 0 2px #a3d2a3 inset}

/* Picker modal */
footer{border-top:1px solid #eee;padding:12px 20px;color:#666}
.picker{position:fixed;inset:0;background:rgba(0,0,0,.32);display:flex;align-items:center;justify-content:center}
.picker.hidden{display:none}
.picker-inner{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:520px;max-width:calc(100% - 32px)}
.picker-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
.picker-head button{border:none;background:#f4f4f4;border-radius:8px;padding:4px 10px;cursor:pointer}
.picker-body{padding:12px}
#pickerFilter{width:100%;margin:8px 0}
#pickerList{list-style:none;margin:0;padding:0;max-height:300px;overflow:auto;border:1px solid #eee;border-radius:8px}
#pickerList li{padding:8px 10px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center}
#pickerList li:last-child{border-bottom:none}
#pickerList li button{padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer}

/* ---- iOS touch & tap fallback ---- */
.slot, .staging-slot, .reserves li { touch-action: none; -webkit-user-select: none; user-select: none; }
html, body { overscroll-behavior: contain; }
.reserves li.selected { outline: 2px solid #6ab1ff; }
.slot.tap-target, .staging-slot.tap-target, .reserve-list.tap-target { box-shadow:0 0 0 2px #6ab1ff inset; }
  </style>
</head>
<body>
  <header>
    <h1>Teamopstelling 3-3-1 – 4 kwarten</h1>
    <p class="sub">8 spelers (incl. keeper) · 11 totaal · Q1: "Te laat" is reserve · Q2–Q4: "Te laat" mag meedoen</p>
  </header>

  <section class="controls">
    <div class="left">
      <button id="generateBtn">Opstellingen genereren</button>
      <button id="saveBtn">Opslaan</button>
      <button id="loadDefaultsBtn" class="ghost">Laad standaardteam</button>
      <button id="resetBtn" class="ghost">Reset naar lege standaard</button>
      <button id="printBtn" class="ghost">Print / PDF</button>
    </div>
    <div class="right">
      <label><input type="checkbox" id="lockDrag"> Drag & drop vergrendelen</label>
      <label style="margin-left:12px"><input type="checkbox" id="editMode"> Bewerkmodus (klik om speler te kiezen)</label>
    </div>
  </section>

  <section class="players">
    <h2>Spelers</h2>
    <div class="scroll">
    <table>
      <thead>
        <tr>
          <th style="width:6rem">Volgorde</th>
          <th>Naam</th>
          <th>Rol</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="playersBody"></tbody>
    </table>
    </div>
    <p class="hint">Volgorde bepaalt selectieprioriteit (1 = eerste). Status: <b>Aanwezig</b>, <b>Te laat</b>, <b>Afwezig</b>.</p>
  </section>

  <section class="quarters">
    <div class="quarter" id="q1">
      <h3>Kwart 1 <span class="badge">Te laat → reserve</span></h3>
      <div class="pitch">
        <div class="row">
          <div class="slot wide" data-slot="q1-gk">Keeper</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q1-d1">D1</div>
          <div class="slot" data-slot="q1-d2">D2</div>
          <div class="slot" data-slot="q1-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q1-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q1-sd2" title="Reserve onder D2">—</div>
          <div class="staging-slot" data-slot="q1-sd3" title="Reserve onder D3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q1-m1">M1</div>
          <div class="slot" data-slot="q1-m2">M2</div>
          <div class="slot" data-slot="q1-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q1-sm1" title="Reserve onder M1">—</div>
          <div class="staging-slot" data-slot="q1-sm2" title="Reserve onder M2">—</div>
          <div class="staging-slot" data-slot="q1-sm3" title="Reserve onder M3">—</div>
        </div>
        <div class="row">
          <div class="slot wide" data-slot="q1-f1">F1</div>
        </div>
        <div class="row staging">
          <div class="staging-slot wide" data-slot="q1-sf1" title="Reserve onder F1">—</div>
        </div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q1-res" class="reserve-list" data-quarter="q1"></ol>
      </div>
    </div>

    <div class="quarter" id="q2">
      <h3>Kwart 2</h3>
      <div class="pitch">
        <div class="row">
          <div class="slot wide" data-slot="q2-gk">Keeper</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q2-d1">D1</div>
          <div class="slot" data-slot="q2-d2">D2</div>
          <div class="slot" data-slot="q2-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q2-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q2-sd2" title="Reserve onder D2">—</div>
          <div class="staging-slot" data-slot="q2-sd3" title="Reserve onder D3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q2-m1">M1</div>
          <div class="slot" data-slot="q2-m2">M2</div>
          <div class="slot" data-slot="q2-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q2-sm1" title="Reserve onder M1">—</div>
          <div class="staging-slot" data-slot="q2-sm2" title="Reserve onder M2">—</div>
          <div class="staging-slot" data-slot="q2-sm3" title="Reserve onder M3">—</div>
        </div>
        <div class="row">
          <div class="slot wide" data-slot="q2-f1">F1</div>
        </div>
        <div class="row staging">
          <div class="staging-slot wide" data-slot="q2-sf1" title="Reserve onder F1">—</div>
        </div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q2-res" class="reserve-list" data-quarter="q2"></ol>
      </div>
    </div>

    <div class="quarter" id="q3">
      <h3>Kwart 3</h3>
      <div class="pitch">
        <div class="row">
          <div class="slot wide" data-slot="q3-gk">Keeper</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q3-d1">D1</div>
          <div class="slot" data-slot="q3-d2">D2</div>
          <div class="slot" data-slot="q3-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q3-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q3-sd2" title="Reserve onder D2">—</div>
          <div class="staging-slot" data-slot="q3-sd3" title="Reserve onder D3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q3-m1">M1</div>
          <div class="slot" data-slot="q3-m2">M2</div>
          <div class="slot" data-slot="q3-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q3-sm1" title="Reserve onder M1">—</div>
          <div class="staging-slot" data-slot="q3-sm2" title="Reserve onder M2">—</div>
          <div class="staging-slot" data-slot="q3-sm3" title="Reserve onder M3">—</div>
        </div>
        <div class="row">
          <div class="slot wide" data-slot="q3-f1">F1</div>
        </div>
        <div class="row staging">
          <div class="staging-slot wide" data-slot="q3-sf1" title="Reserve onder F1">—</div>
        </div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q3-res" class="reserve-list" data-quarter="q3"></ol>
      </div>
    </div>

    <div class="quarter" id="q4">
      <h3>Kwart 4</h3>
      <div class="pitch">
        <div class="row">
          <div class="slot wide" data-slot="q4-gk">Keeper</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q4-d1">D1</div>
          <div class="slot" data-slot="q4-d2">D2</div>
          <div class="slot" data-slot="q4-d3">D3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q4-sd1" title="Reserve onder D1">—</div>
          <div class="staging-slot" data-slot="q4-sd2" title="Reserve onder D2">—</div>
          <div class="staging-slot" data-slot="q4-sd3" title="Reserve onder D3">—</div>
        </div>
        <div class="row">
          <div class="slot" data-slot="q4-m1">M1</div>
          <div class="slot" data-slot="q4-m2">M2</div>
          <div class="slot" data-slot="q4-m3">M3</div>
        </div>
        <div class="row staging">
          <div class="staging-slot" data-slot="q4-sm1" title="Reserve onder M1">—</div>
          <div class="staging-slot" data-slot="q4-sm2" title="Reserve onder M2">—</div>
          <div class="staging-slot" data-slot="q4-sm3" title="Reserve onder M3">—</div>
        </div>
        <div class="row">
          <div class="slot wide" data-slot="q4-f1">F1</div>
        </div>
        <div class="row staging">
          <div class="staging-slot wide" data-slot="q4-sf1" title="Reserve onder F1">—</div>
        </div>
      </div>
      <div class="reserves">
        <h4>Reserves</h4>
        <ol id="q4-res" class="reserve-list" data-quarter="q4"></ol>
      </div>
    </div>
  </section>

  <div id="picker" class="picker hidden">
    <div class="picker-inner">
      <div class="picker-head">
        <strong>Speler kiezen</strong>
        <button id="pickerClose" title="Sluiten">×</button>
      </div>
      <div class="picker-body">
        <label>Filter: <input id="pickerFilter" type="text" placeholder="Zoek naam..."></label>
        <ul id="pickerList"></ul>
      </div>
    </div>
  </div>

  <footer>
    <p>Gemaakt voor Uğur · Werkt volledig offline · Sla status en namen lokaal op.</p>
  </footer>

<script>
/* ==== STATE ==== */
const DEFAULT_PLAYERS = [
  {order:1, name:'Jim', role:'Keeper', status:'Aanwezig'},
  {order:2, name:'Levi', role:'Veldspeler', status:'Aanwezig'},
  {order:3, name:'Lou', role:'Veldspeler', status:'Aanwezig'},
  {order:4, name:'Kanis', role:'Veldspeler', status:'Aanwezig'},
  {order:5, name:'Zeid', role:'Veldspeler', status:'Aanwezig'},
  {order:6, name:'Remy', role:'Veldspeler', status:'Aanwezig'},
  {order:7, name:'Ali', role:'Veldspeler', status:'Aanwezig'},
  {order:8, name:'Devaino', role:'Veldspeler', status:'Aanwezig'},
  {order:9, name:'Nova', role:'Veldspeler', status:'Aanwezig'},
  {order:10, name:'Sam', role:'Veldspeler', status:'Aanwezig'},
  {order:11, name:'Aiden', role:'Veldspeler', status:'Aanwezig'}
];
const STORAGE_KEY='teamopstelling331';
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return{players:DEFAULT_PLAYERS};const obj=JSON.parse(raw);if(!obj.players||!Array.isArray(obj.players))return{players:DEFAULT_PLAYERS};return obj}catch(e){return{players:DEFAULT_PLAYERS}}}
function saveState(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}
let state=loadState();

/* ==== PLAYERS TABLE ==== */
const playersBody=document.getElementById('playersBody');
renderPlayers();
function renderPlayers(){
  playersBody.innerHTML='';
  const players=[...state.players].sort((a,b)=>a.order-b.order);
  players.forEach(p=>{
    const tr=document.createElement('tr');

    const tdOrder=document.createElement('td');
    const inpOrder=document.createElement('input');
    inpOrder.type='number';inpOrder.min='1';inpOrder.max='99';inpOrder.value=p.order;
    inpOrder.addEventListener('change',()=>{p.order=Number(inpOrder.value)||p.order;saveState(state)});
    tdOrder.appendChild(inpOrder);tr.appendChild(tdOrder);

    const tdName=document.createElement('td');
    const inpName=document.createElement('input');
    inpName.type='text';inpName.value=p.name;
    inpName.addEventListener('input',()=>{p.name=inpName.value;saveState(state)});
    tdName.appendChild(inpName);tr.appendChild(tdName);

    const tdRole=document.createElement('td');
    const selRole=document.createElement('select');
    ['Keeper','Veldspeler'].forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;if(p.role===opt)o.selected=true;selRole.appendChild(o)});
    selRole.addEventListener('change',()=>{p.role=selRole.value;saveState(state)});
    tdRole.appendChild(selRole);tr.appendChild(tdRole);

    const tdStatus=document.createElement('td');
    const selStatus=document.createElement('select');
    ['Aanwezig','Te laat','Afwezig'].forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;if(p.status===opt)o.selected=true;selStatus.appendChild(o)});
    selStatus.addEventListener('change',()=>{p.status=selStatus.value;saveState(state)});
    tdStatus.appendChild(selStatus);tr.appendChild(tdStatus);

    playersBody.appendChild(tr);
  });
}

/* ==== SELECTION LOGIC ==== */
function pickGK(players, allowLate){
  const eligible=players.filter(p=>p.status!=='Afwezig'&&(allowLate||p.status==='Aanwezig')).sort((a,b)=>a.order-b.order);
  const keepers=eligible.filter(p=>p.role==='Keeper');
  return keepers[0]||eligible[0]||null;
}
function pickField(players,gk,allowLate){
  const eligible=players.filter(p=>p.name!==gk?.name&&p.status!=='Afwezig'&&(allowLate||p.status==='Aanwezig')).sort((a,b)=>a.order-b.order);
  return {field:eligible.slice(0,7),extras:eligible.slice(7)};
}
function pickReservesQ1(players,gk){
  const late=players.filter(p=>p.status==='Te laat').sort((a,b)=>a.order-b.order);
  const presentElig=players.filter(p=>p.status==='Aanwezig'&&p.name!==gk?.name).sort((a,b)=>a.order-b.order);
  const presentAfter7=presentElig.slice(7);
  return [...late,...presentAfter7].slice(0,3);
}

/* ==== RENDER QUARTERS ==== */
function fillQuarter(prefix,gk,field,reserves){
  const slots=['d1','d2','d3','m1','m2','m3','f1'];
  const gkEl=document.querySelector(`[data-slot="${prefix}-gk"]`);
  gkEl.textContent=gk?gk.name:'—';gkEl.dataset.assigned=gk?gk.name:'';
  slots.forEach((s,i)=>{const el=document.querySelector(`[data-slot="${prefix}-${s}"]`);const name=field[i]?.name||'—';el.textContent=name;el.dataset.assigned=name==='—'?'':name;});
  document.querySelectorAll(`[data-slot^="${prefix}-s"]`).forEach(st=>{st.textContent='—';st.dataset.assigned='';});
  const resOl=document.getElementById(`${prefix}-res`);resOl.innerHTML='';
  (reserves||[]).forEach(r=>{const li=document.createElement('li');li.textContent=r.name;li.className='reserve-item';li.draggable=true;li.dataset.name=r.name;resOl.appendChild(li);});
  hookReserveDnD(resOl);
  hookReserveTap(resOl); // iOS tap fallback voor nieuwe items
}
function generateAll(){
  const roster=[...state.players];
  const gk1=pickGK(roster,false);const {field:f1}=pickField(roster,gk1,false);const r1=pickReservesQ1(roster,gk1);fillQuarter('q1',gk1,f1,r1);
  const gk2=pickGK(roster,true);const {field:f2,extras:ex2}=pickField(roster,gk2,true);fillQuarter('q2',gk2,f2,ex2.slice(0,3));
  const gk3=pickGK(roster,true);const {field:f3,extras:ex3}=pickField(roster,gk3,true);fillQuarter('q3',gk3,f3,ex3.slice(0,3));
  const gk4=pickGK(roster,true);const {field:f4,extras:ex4}=pickField(roster,gk4,true);fillQuarter('q4',gk4,f4,ex4.slice(0,3));
  enableDnD();
  hookSlotClicks();
  hookReserveListsDropZones();
  enableTapTargets(); // iOS tap fallback
}

/* ==== MOUSE DND (v3.4) ==== */
let dragName=null,dragSource=null,dragQuarter=null,originEl=null,currentDraggedReserveItem=null;
function sameQuarter(targetEl){
  const ds=targetEl?.dataset?.slot;if(ds) return ds.split('-')[0]===dragQuarter;
  const dq=targetEl?.closest?.('.reserve-list')?.dataset?.quarter;return dq===dragQuarter;
}
function enableDnD(){
  document.querySelectorAll('.slot').forEach(slot=>{
    slot.setAttribute('draggable','true');
    slot.addEventListener('dragstart',e=>{
      if(document.getElementById('lockDrag').checked){e.preventDefault();return;}
      dragName=slot.textContent;dragSource='slot';dragQuarter=slot.dataset.slot.split('-')[0];originEl=slot;
      e.dataTransfer.setData('text/plain',dragName);slot.classList.add('dragging');markDroppables(true,dragQuarter);
    });
    slot.addEventListener('dragover',e=>{if(document.getElementById('lockDrag').checked)return;if(!sameQuarter(slot))return;e.preventDefault();slot.classList.add('droppable');});
    slot.addEventListener('dragleave',()=>slot.classList.remove('droppable'));
    slot.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked)return;if(!sameQuarter(slot))return;e.preventDefault();
      const toName=slot.textContent;if(!dragName||dragName==='—')return;
      if(dragSource==='slot'){if(originEl&&originEl!==slot){originEl.textContent=toName;originEl.dataset.assigned=toName==='—'?'':toName;slot.textContent=dragName;slot.dataset.assigned=dragName;}}
      else if(dragSource==='reserve'||dragSource==='staging'){removeNameFromQuarter(dragQuarter,dragName);if(toName&&toName!=='—'){appendToReserve(dragQuarter,toName);}slot.textContent=dragName;slot.dataset.assigned=dragName;clearOriginAfterDrop();}
    });
    slot.addEventListener('dragend',()=>{slot.classList.remove('dragging');unmarkDroppables();resetDragState();});
  });
  document.querySelectorAll('.staging-slot').forEach(st=>{
    st.setAttribute('draggable','true');
    st.addEventListener('dragstart',e=>{
      if(document.getElementById('lockDrag').checked){e.preventDefault();return;}
      dragName=st.textContent;dragSource='staging';dragQuarter=st.dataset.slot.split('-')[0];originEl=st;
      e.dataTransfer.setData('text/plain',dragName);st.classList.add('dragging');markDroppables(true,dragQuarter);
    });
    st.addEventListener('dragover',e=>{if(document.getElementById('lockDrag').checked)return;if(!sameQuarter(st))return;e.preventDefault();st.classList.add('droppable');});
    st.addEventListener('dragleave',()=>st.classList.remove('droppable'));
    st.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked)return;if(!sameQuarter(st))return;e.preventDefault();
      if(!dragName||dragName==='—')return;const occupied=st.textContent&&st.textContent!=='—'?st.textContent:null;
      removeNameFromQuarter(dragQuarter,dragName);if(occupied){appendToReserve(dragQuarter,occupied);}st.textContent=dragName;st.dataset.assigned=dragName;clearOriginAfterDrop();
    });
    st.addEventListener('dragend',()=>{st.classList.remove('dragging');unmarkDroppables();resetDragState();});
  });
}
function hookReserveDnD(resList){
  resList.querySelectorAll('.reserve-item').forEach(li=>{
    li.addEventListener('dragstart',e=>{
      if(document.getElementById('lockDrag').checked){e.preventDefault();return;}
      dragName=li.dataset.name||li.textContent;dragSource='reserve';dragQuarter=resList.dataset.quarter;originEl=null;currentDraggedReserveItem=li;li.classList.add('dragging');markDroppables(true,dragQuarter);
    });
    li.addEventListener('dragend',()=>{if(li)li.classList.remove('dragging');unmarkDroppables();resetDragState();});
  });
}
function hookReserveListsDropZones(){
  document.querySelectorAll('.reserve-list').forEach(ol=>{
    ol.addEventListener('dragover',e=>{if(document.getElementById('lockDrag').checked)return;if(ol.dataset.quarter!==dragQuarter)return;e.preventDefault();ol.classList.add('droppable');});
    ol.addEventListener('dragleave',()=> ol.classList.remove('droppable'));
    ol.addEventListener('drop',e=>{
      if(document.getElementById('lockDrag').checked)return;if(ol.dataset.quarter!==dragQuarter)return;e.preventDefault();ol.classList.remove('droppable');
      if(dragSource==='slot'||dragSource==='staging'){if(originEl){const name=originEl.textContent;if(name&&name!=='—')appendToReserve(dragQuarter,name);originEl.textContent='—';originEl.dataset.assigned='';}}
      else if(dragSource==='reserve'){if(currentDraggedReserveItem&&currentDraggedReserveItem.parentElement){currentDraggedReserveItem.parentElement.removeChild(currentDraggedReserveItem);ol.appendChild(currentDraggedReserveItem);}}
    });

    /* TAP fallback op reserve-lijst */
    ol.addEventListener('click', ()=>{ if(tapSel) handleTapPlaceOnReserveList(ol); });
    ol.addEventListener('touchend', (e)=>{ if(tapSel){ if(e.cancelable) e.preventDefault(); handleTapPlaceOnReserveList(ol); }});
  });
}
function appendToReserve(qPrefix,name){
  const ol=document.getElementById(`${qPrefix}-res`);const li=document.createElement('li');li.textContent=name;li.className='reserve-item';li.draggable=true;li.dataset.name=name;ol.appendChild(li);hookReserveDnD(ol);hookReserveTap(ol);
}
function markDroppables(on,q){document.querySelectorAll(`[data-slot^="${q}-"]`).forEach(el=>{if(on)el.classList.add('droppable');else el.classList.remove('droppable');});const ol=document.getElementById(`${q}-res`);if(on)ol.classList.add('droppable');else ol.classList.remove('droppable');}
function unmarkDroppables(){document.querySelectorAll('.droppable').forEach(el=>el.classList.remove('droppable'))}
function clearOriginAfterDrop(){if(!originEl)return;if(originEl.classList.contains('slot')||originEl.classList.contains('staging-slot')){originEl.textContent='—';originEl.dataset.assigned='';}if(currentDraggedReserveItem&&currentDraggedReserveItem.parentElement){currentDraggedReserveItem.parentElement.removeChild(currentDraggedReserveItem);}}
function resetDragState(){dragName=null;dragSource=null;dragQuarter=null;originEl=null;currentDraggedReserveItem=null;}
function removeNameFromQuarter(q,name){
  if(!name)return;
  document.querySelectorAll(`[data-slot^="${q}-"]`).forEach(el=>{if(el.dataset.assigned===name||el.textContent===name){el.textContent='—';el.dataset.assigned='';}});
  const li=Array.from(document.querySelectorAll(`#${q}-res .reserve-item`)).find(x=>x.dataset.name===name);
  if(li&&li.parentElement){li.parentElement.removeChild(li);}
}

/* ==== EDIT MODE (picker) ==== */
const editMode=document.getElementById('editMode');
const picker=document.getElementById('picker');
const pickerList=document.getElementById('pickerList');
const pickerFilter=document.getElementById('pickerFilter');
const pickerClose=document.getElementById('pickerClose');
let activeSlot=null;
function hookSlotClicks(){
  document.querySelectorAll('.slot,.staging-slot').forEach(slot=>{
    slot.addEventListener('click',()=>{if(!editMode.checked)return;openPicker(slot);});
    editMode.addEventListener('change',()=>{slot.classList.toggle('editable',editMode.checked);});
    slot.classList.toggle('editable',editMode.checked);

    /* TAP fallback op slot/staging als doel */
    slot.addEventListener('click', ()=>{ if(tapSel) handleTapPlaceOnSlot(slot); });
    slot.addEventListener('touchend', (e)=>{ if(tapSel){ if(e.cancelable) e.preventDefault(); handleTapPlaceOnSlot(slot); }});
  });
}
function openPicker(slotEl){activeSlot=slotEl;buildPickerList('');picker.classList.remove('hidden');pickerFilter.value='';pickerFilter.focus();}
function closePicker(){picker.classList.add('hidden');activeSlot=null;}
pickerClose.addEventListener('click',closePicker);
picker.addEventListener('click',e=>{if(e.target===picker)closePicker();});
pickerFilter.addEventListener('input',()=>buildPickerList(pickerFilter.value||''));
function buildPickerList(filter){
  const roster=[...state.players];
  const qPrefix=activeSlot.dataset.slot.split('-')[0];
  const usedNames=Array.from(document.querySelectorAll(`[data-slot^="${qPrefix}-"]`)).map(el=>el.dataset.assigned).filter(Boolean);
  const list=roster.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())).sort((a,b)=>a.order-b.order);
  pickerList.innerHTML='';
  list.forEach(p=>{
    const li=document.createElement('li');const span=document.createElement('span');span.textContent=`${p.name} · ${p.role} · ${p.status}`;
    const btn=document.createElement('button');btn.textContent=usedNames.includes(p.name)?'Verplaatsen':'Kies';
    btn.addEventListener('click',()=>assignPlayerToSlot(p.name,activeSlot));
    li.appendChild(span);li.appendChild(btn);pickerList.appendChild(li);
  });
  const liEmpty=document.createElement('li');const spanEmpty=document.createElement('span');spanEmpty.textContent='— (leegmaken)';
  const btnEmpty=document.createElement('button');btnEmpty.textContent='Leeg';btnEmpty.addEventListener('click',()=>assignPlayerToSlot('',activeSlot));
  liEmpty.appendChild(spanEmpty);liEmpty.appendChild(btnEmpty);pickerList.appendChild(liEmpty);
}
function assignPlayerToSlot(name,slotEl){
  const qPrefix=slotEl.dataset.slot.split('-')[0];
  if(name){removeNameFromQuarter(qPrefix,name);}
  const prev=slotEl.textContent;
  slotEl.textContent=name||'—';slotEl.dataset.assigned=name||'';
  if(prev&&prev!=='—'&&slotEl.classList.contains('slot')&&name){appendToReserve(qPrefix,prev);}
  closePicker();
}

/* ==== TAP-SELECT FALLBACK (iOS) ==== */
let tapSel = null; // { name, source:'reserve'|'slot'|'staging', quarter, originEl }
function clearTapState(){
  document.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));
  document.querySelectorAll('.tap-target').forEach(el=>el.classList.remove('tap-target'));
  tapSel = null;
}
function startTapSelect(name, source, quarter, originEl){
  tapSel = { name, source, quarter, originEl };
  document.querySelectorAll(`[data-slot^="${quarter}-"]`).forEach(el=>el.classList.add('tap-target'));
  document.getElementById(`${quarter}-res`)?.classList.add('tap-target');
}
function handleTapPlaceOnSlot(slot){
  if(!tapSel) return;
  const q = slot.dataset.slot.split('-')[0];
  if(q !== tapSel.quarter) return;
  const toName = slot.textContent;
  const name = tapSel.name;

  if(tapSel.source === 'slot'){
    if(tapSel.originEl !== slot){
      tapSel.originEl.textContent = toName;
      tapSel.originEl.dataset.assigned = (toName==='—'?'':toName);
      slot.textContent = name; slot.dataset.assigned = name;
    }
  } else if(tapSel.source === 'reserve' || tapSel.source === 'staging'){
    removeNameFromQuarter(q, name);
    if(toName && toName !== '—'){ appendToReserve(q, toName); }
    slot.textContent = name; slot.dataset.assigned = name;
    if(tapSel.source === 'staging'){
      tapSel.originEl.textContent = '—'; tapSel.originEl.dataset.assigned = '';
    }
    if(tapSel.source === 'reserve' && tapSel.originEl?.parentElement){
      tapSel.originEl.parentElement.removeChild(tapSel.originEl);
    }
  }
  clearTapState();
}
function handleTapPlaceOnReserveList(list){
  if(!tapSel) return;
  const q = list.dataset.quarter;
  if(q !== tapSel.quarter) return;

  if(tapSel.source === 'slot' || tapSel.source === 'staging'){
    const name = tapSel.originEl.textContent;
    if(name && name !== '—') appendToReserve(q, name);
    tapSel.originEl.textContent = '—'; tapSel.originEl.dataset.assigned = '';
  } else if(tapSel.source === 'reserve'){
    if(tapSel.originEl?.parentElement){
      tapSel.originEl.parentElement.removeChild(tapSel.originEl);
      list.appendChild(tapSel.originEl);
    }
  }
  clearTapState();
}
function hookReserveTap(list){
  list.querySelectorAll('.reserve-item').forEach(li=>{
    li.addEventListener('click', ()=>{
      const q=list.dataset.quarter;
      clearTapState();
      li.classList.add('selected');
      startTapSelect(li.dataset.name||li.textContent, 'reserve', q, li);
    });
    li.addEventListener('touchend', (e)=>{
      if(e.cancelable) e.preventDefault();
      const q=list.dataset.quarter;
      clearTapState();
      li.classList.add('selected');
      startTapSelect(li.dataset.name||li.textContent, 'reserve', q, li);
    });
  });
}
function enableTapTargets(){
  document.querySelectorAll('.slot,.staging-slot').forEach(el=>{
    el.addEventListener('click', ()=>{ if(tapSel) handleTapPlaceOnSlot(el); });
    el.addEventListener('touchend', (e)=>{ if(tapSel){ if(e.cancelable) e.preventDefault(); handleTapPlaceOnSlot(el); }});
  });
  document.querySelectorAll('.reserve-list').forEach(ol=>{
    ol.addEventListener('click', ()=>{ if(tapSel) handleTapPlaceOnReserveList(ol); });
    ol.addEventListener('touchend', (e)=>{ if(tapSel){ if(e.cancelable) e.preventDefault(); handleTapPlaceOnReserveList(ol); }});
  });
}

/* ==== BUTTONS ==== */
document.getElementById('generateBtn').addEventListener('click',()=>{renderPlayers();generateAll();});
document.getElementById('saveBtn').addEventListener('click',()=>{saveState(state);alert('Opgeslagen! Namen, rollen en statussen staan lokaal opgeslagen.');});
document.getElementById('loadDefaultsBtn').addEventListener('click',()=>{
  if(!confirm('Standaardteam laden (Jim, Levi, Lou, ...)? Dit vervangt alleen de spelerslijst.')) return;
  state.players=JSON.parse(JSON.stringify(DEFAULT_PLAYERS));saveState(state);renderPlayers();generateAll();
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm('Reset naar lege standaard (Speler 1..11)?')){
    state={players:Array.from({length:11},(_,i)=>({order:i+1,name:`Speler ${i+1}`,role:i===0?'Keeper':'Veldspeler',status:'Aanwezig'}))};
    saveState(state);renderPlayers();generateAll();
  }
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());

/* ==== INIT ==== */
generateAll();            // bouw Q1..Q4
enableTapTargets();       // activeer iOS tap fallback
</script>
</body>
</html>
